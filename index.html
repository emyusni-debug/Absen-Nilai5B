<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absensi dan Nilai 5B - MIS Hidayatul Mubtadiin</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Nunito', sans-serif;
        }

        :root {
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a35;
            --accent-cyan: #00d4ff;
            --accent-pink: #ff00aa;
            --accent-yellow: #ffcc00;
            --accent-green: #00ff88;
            --accent-purple: #aa00ff;
            --accent-orange: #ff6600;
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        body {
            background: var(--bg-primary);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 0, 170, 0.1) 0%, transparent 50%);
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 15px;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
        }

        .connection-status.online {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid var(--accent-green);
            color: var(--accent-green);
        }

        .connection-status.offline {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid #ff4444;
            color: #ff4444;
        }

        .connection-status.loading {
            background: rgba(255, 204, 0, 0.2);
            border: 1px solid var(--accent-yellow);
            color: var(--accent-yellow);
        }

        .connection-status .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .connection-status.online .dot { background: var(--accent-green); }
        .connection-status.offline .dot { background: #ff4444; }
        .connection-status.loading .dot { background: var(--accent-yellow); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Menu Header */
        .menu-header {
            text-align: center;
            padding: 25px 20px;
        }

        .school-logo {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 2rem;
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
        }

        .menu-header h1 {
            font-size: 1.3rem;
            font-weight: 800;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .menu-header h2 {
            font-size: 0.85rem;
            color: var(--text-secondary);
            letter-spacing: 1px;
        }

        .class-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 8px 16px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            font-size: 0.8rem;
        }

        /* Stats Row */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .stat-card {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 15px 10px;
            text-align: center;
        }

        .stat-card .value {
            font-size: 1.4rem;
            font-weight: 800;
        }

        .stat-card:nth-child(1) .value { color: var(--accent-cyan); }
        .stat-card:nth-child(2) .value { color: var(--accent-green); }
        .stat-card:nth-child(3) .value { color: var(--accent-pink); }

        .stat-card .label {
            font-size: 0.65rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Detail Stats */
        .detail-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .detail-stat {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detail-stat i {
            font-size: 1.2rem;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }

        .detail-stat:nth-child(1) i { background: rgba(0, 212, 255, 0.2); color: var(--accent-cyan); }
        .detail-stat:nth-child(2) i { background: rgba(255, 102, 0, 0.2); color: var(--accent-orange); }

        .detail-stat .info .num { font-size: 1.1rem; font-weight: 700; }
        .detail-stat .info .txt { font-size: 0.7rem; color: var(--text-secondary); }

        /* Menu Bento */
        .menu-bento {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .bento-card {
            position: relative;
            border-radius: 18px;
            padding: 20px 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            overflow: hidden;
        }

        .bento-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: -1;
        }

        .bento-card.absensi::before { background: linear-gradient(135deg, #1e3a5f, #0d1f33); }
        .bento-card.absensi { border-color: rgba(0, 212, 255, 0.3); }
        .bento-card.absensi:active { border-color: var(--accent-cyan); box-shadow: 0 0 25px rgba(0, 212, 255, 0.3); }

        .bento-card.bindo::before { background: linear-gradient(135deg, #3d1e5f, #1f0d33); }
        .bento-card.bindo { border-color: rgba(170, 0, 255, 0.3); }
        .bento-card.bindo:active { border-color: var(--accent-purple); box-shadow: 0 0 25px rgba(170, 0, 255, 0.3); }

        .bento-card.ppkn::before { background: linear-gradient(135deg, #5f1e3d, #330d1f); }
        .bento-card.ppkn { border-color: rgba(255, 0, 170, 0.3); }
        .bento-card.ppkn:active { border-color: var(--accent-pink); box-shadow: 0 0 25px rgba(255, 0, 170, 0.3); }

        .bento-card.kejadian::before { background: linear-gradient(135deg, #5f4d1e, #332a0d); }
        .bento-card.kejadian { border-color: rgba(255, 102, 0, 0.3); }
        .bento-card.kejadian:active { border-color: var(--accent-orange); box-shadow: 0 0 25px rgba(255, 102, 0, 0.3); }

        .bento-card:active { transform: scale(0.98); }

        .card-icon {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            margin-bottom: 12px;
        }

        .bento-card.absensi .card-icon { background: linear-gradient(135deg, #00d4ff, #0099cc); }
        .bento-card.bindo .card-icon { background: linear-gradient(135deg, #aa00ff, #7700b3); }
        .bento-card.ppkn .card-icon { background: linear-gradient(135deg, #ff00aa, #cc0088); }
        .bento-card.kejadian .card-icon { background: linear-gradient(135deg, #ff6600, #cc5200); }

        .bento-card h3 { font-size: 0.95rem; font-weight: 700; margin-bottom: 3px; }
        .bento-card p { font-size: 0.7rem; color: var(--text-secondary); }

        /* Menu Footer */
        .menu-footer {
            margin-top: 20px;
            padding: 15px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .teacher-avatar {
            width: 45px;
            height: 45px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-green), #00cc6a);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }

        .teacher-info h4 { font-size: 0.85rem; }
        .teacher-info p { font-size: 0.7rem; color: var(--text-secondary); }

        /* Nav Bar */
        .nav-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            gap: 8px;
            flex-wrap: wrap;
        }

        .nav-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 14px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-back { background: linear-gradient(135deg, var(--accent-cyan), #0099cc); color: #fff; }
        .btn-save { background: linear-gradient(135deg, var(--accent-green), #00cc6a); color: #000; }
        .btn-reset { background: linear-gradient(135deg, #ff6b6b, #ee5a5a); color: #fff; }
        .btn-rekap { background: linear-gradient(135deg, var(--accent-purple), #7700b3); color: #fff; }

        .nav-btn:active { transform: scale(0.95); }
        .btn-group { display: flex; gap: 6px; }

        /* Page Title */
        .page-title {
            text-align: center;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
        }

        .page-title h2 { font-size: 1.1rem; margin-bottom: 3px; }
        .page-title p { font-size: 0.75rem; color: var(--text-secondary); }

        /* Date Controls */
        .date-controls {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .date-input-group { margin-bottom: 12px; }
        .date-input-group label { display: block; font-size: 0.8rem; margin-bottom: 6px; font-weight: 600; }
        .date-input-group input[type="date"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--glass-border);
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 0.9rem;
        }

        .holiday-check {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .holiday-check label { font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .holiday-check input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--accent-cyan); }
        .holiday-check input[type="text"] {
            flex: 1;
            padding: 8px 10px;
            border: 2px solid var(--glass-border);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 0.85rem;
            min-width: 120px;
        }

        .holiday-indicator {
            background: linear-gradient(135deg, var(--accent-orange), #cc5200);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 12px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        /* Table */
        .table-container {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            overflow: hidden;
        }

        .table-scroll {
            overflow-x: auto;
            max-height: 55vh;
            overflow-y: auto;
        }

        table { width: 100%; border-collapse: collapse; min-width: 350px; }
        th, td { padding: 10px 8px; text-align: center; border: 1px solid var(--glass-border); font-size: 0.8rem; }
        th {
            background: linear-gradient(135deg, rgba(0,212,255,0.2), rgba(170,0,255,0.2));
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 0.7rem;
            text-transform: uppercase;
        }

        .sticky-col { position: sticky; background: var(--bg-secondary); z-index: 5; }
        .sticky-col-no { left: 0; min-width: 35px; }
        .sticky-col-nama { left: 35px; min-width: 70px; text-align: left !important; }
        th.sticky-col { z-index: 15; background: linear-gradient(135deg, rgba(0,212,255,0.3), rgba(170,0,255,0.3)); }

        tr:nth-child(even) td { background: rgba(255,255,255,0.02); }
        tr:nth-child(even) .sticky-col { background: #1f1f3a; }
        tr:hover td { background: rgba(0,212,255,0.1) !important; }

        .nama-siswa { text-align: left; }
        .nama-depan { font-weight: 700; font-size: 0.75rem; color: var(--accent-cyan); display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .nama-belakang { font-size: 0.65rem; opacity: 0.6; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Absen Buttons */
        .absen-group { display: flex; gap: 5px; justify-content: center; }
        .absen-btn {
            width: 32px; height: 32px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 800;
            font-size: 0.7rem;
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.5);
            transition: all 0.2s;
        }

        .absen-btn.h.active { background: var(--accent-cyan); color: #000; border-color: var(--accent-cyan); }
        .absen-btn.s.active { background: var(--accent-yellow); color: #000; border-color: var(--accent-yellow); }
        .absen-btn.i.active { background: var(--accent-orange); color: #000; border-color: var(--accent-orange); }
        .absen-btn.a.active { background: #ff4444; color: #fff; border-color: #ff4444; }

        /* Nilai Input */
        .nilai-input {
            width: 42px;
            padding: 6px 4px;
            border: 2px solid var(--glass-border);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            text-align: center;
            font-weight: 700;
            font-size: 0.8rem;
        }

        .nilai-input:focus { border-color: var(--accent-cyan); outline: none; }

        .nilai-rata {
            background: linear-gradient(135deg, var(--accent-green), #00cc6a);
            color: #000;
            font-weight: 800;
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
        }

        /* Kejadian Form */
        .kejadian-form {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; }
        .form-group select, .form-group textarea, .form-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--glass-border);
            border-radius: 10px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 0.9rem;
        }
        .form-group select option { background: var(--bg-secondary); }
        .form-group textarea { min-height: 80px; resize: vertical; }

        .kejadian-list { display: grid; gap: 8px; }
        .kejadian-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border: 2px solid var(--glass-border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .kejadian-item.selected { background: rgba(0,212,255,0.1); border-color: var(--accent-cyan); }
        .kejadian-item input { width: 18px; height: 18px; pointer-events: none; accent-color: var(--accent-cyan); }
        .kejadian-info { flex: 1; }
        .kejadian-info h4 { font-size: 0.85rem; }
        .kejadian-info span { font-size: 0.7rem; color: var(--text-secondary); }
        .poin-badge { background: linear-gradient(135deg, var(--accent-pink), #cc0088); padding: 5px 10px; border-radius: 15px; font-weight: 700; font-size: 0.75rem; }

        .red-mark { background: rgba(255,68,68,0.15) !important; border-left: 3px solid #ff4444; }
        .parent-call { background: rgba(255,0,0,0.2) !important; animation: alertPulse 1.5s infinite; }
        @keyframes alertPulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }

        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; padding: 15px; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-secondary); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; max-width: 95%; max-height: 85vh; overflow-y: auto; position: relative; width: 100%; }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; cursor: pointer; opacity: 0.7; background: rgba(255,255,255,0.1); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .modal h2 { font-size: 1.1rem; margin-bottom: 15px; }

        /* Loading & Toast */
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; flex-direction: column; gap: 15px; }
        .loading.active { display: flex; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent-cyan); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .toast { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%) translateY(150%); padding: 12px 25px; border-radius: 50px; font-weight: 600; z-index: 3000; font-size: 0.85rem; transition: transform 0.3s ease; max-width: 90%; text-align: center; }
        .toast.show { transform: translateX(-50%) translateY(0); }
        .toast.success { background: linear-gradient(135deg, var(--accent-green), #00cc6a); color: #000; }
        .toast.error { background: linear-gradient(135deg, #ff4444, #cc0000); color: #fff; }
        .toast.info { background: linear-gradient(135deg, var(--accent-cyan), #0099cc); color: #000; }

        .status-hadir { color: var(--accent-cyan); font-weight: 700; }
        .status-sakit { color: var(--accent-yellow); font-weight: 700; }
        .status-izin { color: var(--accent-orange); font-weight: 700; }
        .status-alpha { color: #ff4444; font-weight: 700; }

        @media (max-width: 400px) {
            .stats-row { gap: 6px; }
            .stat-card { padding: 10px 6px; }
            .stat-card .value { font-size: 1.2rem; }
            .bento-card { padding: 15px 12px; }
            .card-icon { width: 40px; height: 40px; font-size: 1.1rem; }
            .bento-card h3 { font-size: 0.85rem; }
            .absen-btn { width: 28px; height: 28px; font-size: 0.65rem; }
            .nilai-input { width: 36px; font-size: 0.75rem; }
        }
    </style>
</head>
<body>
    <div class="bg-animation"></div>

    <div class="connection-status loading" id="connectionStatus">
        <span class="dot"></span>
        <span id="connectionText">Menghubungkan...</span>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p id="loadingText">Memuat...</p>
    </div>

    <div class="toast" id="toast"></div>

    <div class="container">
        <!-- MENU PAGE -->
        <div class="page active" id="page-menu">
            <div class="menu-header">
                <div class="school-logo">ðŸ“š</div>
                <h1>Absensi & Nilai Kelas 5B</h1>
                <h2>MIS Hidayatul Mubtadiin</h2>
                <div class="class-badge">
                    <span>TP 2025/2026 â€¢ Semester Genap</span>
                </div>
            </div>

            <div class="stats-row">
                <div class="stat-card">
                    <div class="value" id="stat-siswa">23</div>
                    <div class="label">Total Siswa</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="stat-kehadiran">-%</div>
                    <div class="label">Kehadiran</div>
                </div>
                <div class="stat-card">
                    <div class="value" id="stat-hari">0</div>
                    <div class="label">Hari Efektif</div>
                </div>
            </div>

            <div class="detail-stats">
                <div class="detail-stat">
                    <i class="fas fa-calendar-times"></i>
                    <div class="info">
                        <div class="num" id="stat-libur">0</div>
                        <div class="txt">Hari Libur</div>
                    </div>
                </div>
                <div class="detail-stat">
                    <i class="fas fa-exclamation-triangle"></i>
                    <div class="info">
                        <div class="num" id="stat-kejadian">0</div>
                        <div class="txt">Kejadian</div>
                    </div>
                </div>
            </div>

            <div class="menu-bento">
                <div class="bento-card absensi" onclick="showPage('absensi')">
                    <div class="card-icon"><i class="fas fa-user-check"></i></div>
                    <h3>Absensi</h3>
                    <p>Kehadiran harian</p>
                </div>
                <div class="bento-card bindo" onclick="showPage('nilai-bi')">
                    <div class="card-icon"><i class="fas fa-book"></i></div>
                    <h3>B. Indonesia</h3>
                    <p>Input nilai</p>
                </div>
                <div class="bento-card ppkn" onclick="showPage('nilai-ppkn')">
                    <div class="card-icon"><i class="fas fa-landmark"></i></div>
                    <h3>PPKn</h3>
                    <p>Input nilai</p>
                </div>
                <div class="bento-card kejadian" onclick="showPage('kejadian')">
                    <div class="card-icon"><i class="fas fa-clipboard-list"></i></div>
                    <h3>Kejadian</h3>
                    <p>Catat pelanggaran</p>
                </div>
            </div>

            <div class="menu-footer">
                <div class="teacher-avatar"><i class="fas fa-user-tie"></i></div>
                <div class="teacher-info">
                    <h4>M. Yusni</h4>
                    <p>Wali Kelas 5B</p>
                </div>
            </div>
        </div>

        <!-- ABSENSI PAGE -->
        <div class="page" id="page-absensi">
            <div class="nav-bar">
                <button class="nav-btn btn-back" onclick="goToMenu()"><i class="fas fa-arrow-left"></i> Menu</button>
                <div class="btn-group">
                    <button class="nav-btn btn-rekap" onclick="showRekapAbsensi()"><i class="fas fa-chart-bar"></i></button>
                    <button class="nav-btn btn-save" onclick="saveAbsensi()"><i class="fas fa-save"></i> Simpan</button>
                </div>
            </div>
            <div class="page-title">
                <h2><i class="fas fa-user-check"></i> Absensi Harian</h2>
                <p>Pilih tanggal dan catat kehadiran</p>
            </div>
            <div class="date-controls">
                <div class="date-input-group">
                    <label><i class="fas fa-calendar"></i> Tanggal</label>
                    <input type="date" id="tanggal-absen" onchange="loadAbsensiByDate()">
                </div>
                <div class="holiday-check">
                    <label><input type="checkbox" id="is-holiday" onchange="toggleHoliday()"> Libur</label>
                    <input type="text" id="alasan-libur" placeholder="Alasan libur..." disabled>
                </div>
            </div>
            <div id="holiday-indicator" class="holiday-indicator" style="display:none;"><i class="fas fa-info-circle"></i> Hari Libur</div>
            <div class="table-container" id="table-container-absensi">
                <div class="table-scroll">
                    <table><thead><tr>
                        <th class="sticky-col sticky-col-no">No</th>
                        <th class="sticky-col sticky-col-nama">Nama</th>
                        <th>Status</th>
                    </tr></thead><tbody id="tbody-absensi"></tbody></table>
                </div>
            </div>
        </div>

        <!-- NILAI BI PAGE -->
        <div class="page" id="page-nilai-bi">
            <div class="nav-bar">
                <button class="nav-btn btn-back" onclick="goToMenu()"><i class="fas fa-arrow-left"></i> Menu</button>
                <div class="btn-group">
                    <button class="nav-btn btn-rekap" onclick="showRekapNilai('bi')"><i class="fas fa-chart-bar"></i></button>
                    <button class="nav-btn btn-save" onclick="saveNilai('bi')"><i class="fas fa-save"></i> Simpan</button>
                </div>
            </div>
            <div class="page-title">
                <h2><i class="fas fa-book"></i> Nilai B. Indonesia</h2>
                <p>NH=Nilai Harian, STS=Tengah Semester, SAT=Akhir Tahun</p>
            </div>
            <div class="table-container">
                <div class="table-scroll">
                    <table><thead><tr>
                        <th class="sticky-col sticky-col-no">No</th>
                        <th class="sticky-col sticky-col-nama">Nama</th>
                        <th>NH1</th><th>NH2</th><th>NH3</th><th>NH4</th><th>NH5</th><th>STS</th><th>SAT</th><th>RataÂ²</th>
                    </tr></thead><tbody id="tbody-nilai-bi"></tbody></table>
                </div>
            </div>
        </div>

        <!-- NILAI PPKN PAGE -->
        <div class="page" id="page-nilai-ppkn">
            <div class="nav-bar">
                <button class="nav-btn btn-back" onclick="goToMenu()"><i class="fas fa-arrow-left"></i> Menu</button>
                <div class="btn-group">
                    <button class="nav-btn btn-rekap" onclick="showRekapNilai('ppkn')"><i class="fas fa-chart-bar"></i></button>
                    <button class="nav-btn btn-save" onclick="saveNilai('ppkn')"><i class="fas fa-save"></i> Simpan</button>
                </div>
            </div>
            <div class="page-title">
                <h2><i class="fas fa-landmark"></i> Nilai PPKn</h2>
                <p>NH=Nilai Harian, STS=Tengah Semester, SAT=Akhir Tahun</p>
            </div>
            <div class="table-container">
                <div class="table-scroll">
                    <table><thead><tr>
                        <th class="sticky-col sticky-col-no">No</th>
                        <th class="sticky-col sticky-col-nama">Nama</th>
                        <th>NH1</th><th>NH2</th><th>NH3</th><th>NH4</th><th>NH5</th><th>STS</th><th>SAT</th><th>RataÂ²</th>
                    </tr></thead><tbody id="tbody-nilai-ppkn"></tbody></table>
                </div>
            </div>
        </div>

        <!-- KEJADIAN PAGE -->
        <div class="page" id="page-kejadian">
            <div class="nav-bar">
                <button class="nav-btn btn-back" onclick="goToMenu()"><i class="fas fa-arrow-left"></i> Menu</button>
                <div class="btn-group">
                    <button class="nav-btn btn-rekap" onclick="showRekapKejadian()"><i class="fas fa-chart-bar"></i></button>
                    <button class="nav-btn btn-save" onclick="saveKejadian()"><i class="fas fa-save"></i> Simpan</button>
                </div>
            </div>
            <div class="page-title">
                <h2><i class="fas fa-clipboard-list"></i> Catatan Kejadian</h2>
                <p>Dokumentasi pelanggaran siswa</p>
            </div>
            <div class="kejadian-form">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Siswa</label>
                    <select id="select-siswa-kejadian"><option value="">-- Pilih --</option></select>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-calendar"></i> Tanggal</label>
                    <input type="date" id="tanggal-kejadian">
                </div>
                <div class="form-group">
                    <label><i class="fas fa-list"></i> Pelanggaran</label>
                    <div class="kejadian-list">
                        <div class="kejadian-item" onclick="toggleKejadian(this,1)">
                            <input type="checkbox" id="kej-1">
                            <div class="kejadian-info"><h4>Berkata Kotor</h4><span>Max 5x</span></div>
                            <span class="poin-badge">5</span>
                        </div>
                        <div class="kejadian-item" onclick="toggleKejadian(this,2)">
                            <input type="checkbox" id="kej-2">
                            <div class="kejadian-info"><h4>Tidak Masuk Ulangan</h4><span>Max 5x</span></div>
                            <span class="poin-badge">5</span>
                        </div>
                        <div class="kejadian-item" onclick="toggleKejadian(this,3)">
                            <input type="checkbox" id="kej-3">
                            <div class="kejadian-info"><h4>Pembulian</h4><span>Max 3x</span></div>
                            <span class="poin-badge">10</span>
                        </div>
                        <div class="kejadian-item" onclick="toggleKejadian(this,4)">
                            <input type="checkbox" id="kej-4">
                            <div class="kejadian-info"><h4>Bertengkar</h4><span>Max 3x</span></div>
                            <span class="poin-badge">25</span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label><i class="fas fa-edit"></i> Catatan</label>
                    <textarea id="catatan-kejadian" placeholder="Detail..."></textarea>
                </div>
                <button class="nav-btn btn-save" onclick="addKejadian()" style="width:100%;padding:12px;"><i class="fas fa-plus"></i> Tambah</button>
            </div>
            <div class="table-container">
                <div class="table-scroll">
                    <table><thead><tr><th>No</th><th>Tgl</th><th>Nama</th><th>Jenis</th><th>Poin</th><th>#</th></tr></thead>
                    <tbody id="tbody-kejadian"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <div class="modal" id="modal-rekap-absensi">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('modal-rekap-absensi')">&times;</span>
            <h2><i class="fas fa-chart-bar"></i> Rekap Absensi</h2>
            <div class="table-scroll">
                <table><thead><tr><th>No</th><th>Nama</th><th>H</th><th>S</th><th>I</th><th>A</th><th>%</th></tr></thead>
                <tbody id="tbody-rekap-absensi"></tbody></table>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-rekap-nilai">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('modal-rekap-nilai')">&times;</span>
            <h2><i class="fas fa-chart-line"></i> Rekap Nilai</h2>
            <div class="table-scroll" id="content-rekap-nilai"></div>
        </div>
    </div>

    <div class="modal" id="modal-rekap-kejadian">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('modal-rekap-kejadian')">&times;</span>
            <h2><i class="fas fa-exclamation-circle"></i> Rekap Poin</h2>
            <div class="table-scroll">
                <table><thead><tr><th>No</th><th>Nama</th><th>Poin</th><th>Status</th></tr></thead>
                <tbody id="tbody-rekap-kejadian"></tbody></table>
            </div>
        </div>
    </div>

    <script>
        // ============ KONFIGURASI ============
        const API_URL = 'https://script.google.com/macros/s/AKfycbwPyHTujSV-sq22tvSVD0BxdmIhHHsg2tV8GQLjc7qHh3JzRDmCWKduTNN6dKzMm_Ds/exec';

        const siswaList = [
            "Abdul Basith", "Abdullah Asyfaq Nawawi", "Abid Aqilla Rajendra",
            "Afreza Dwi Saputra", "Anindita Keisha Azzahra", "Friska Dila Aulia",
            "Jemmy Rachad Nazzih", "Kinara Syaqila Anggraini", "Moh Fauzus Salam",
            "Muhammad Azka Alvaro", "Muhammad Erlangga", "Muhammad Zidna Ilman",
            "Muhammad Zulfan Alfatir", "Nahwa Kamilatun Nisa", "Nilam Ainur Rohmah",
            "Nindia Ramadhani", "Safitri", "Nurin Najwa", "Rafa Aditya Putra",
            "Talita Indah Ayu Septiana", "Wildan Faza Aufar", "Zalfa Rahmuna Yasmin", "Risa"
        ];

        const jenisKejadian = {
            1: { nama: "Berkata Kotor", poin: 5 },
            2: { nama: "Tidak Masuk Saat Ulangan", poin: 5 },
            3: { nama: "Pembulian", poin: 10 },
            4: { nama: "Bertengkar", poin: 25 }
        };

        let dataAbsensi = {};
        let dataLibur = {};
        let dataNilaiBi = {};
        let dataNilaiPpkn = {};
        let dataKejadian = [];

        // ============ UTILITIES ============
        function formatNama(nama) {
            const parts = nama.split(' ');
            return { depan: parts[0], belakang: parts.slice(1).join(' ') };
        }

        function formatDate(d) { return new Date(d).toISOString().split('T')[0]; }
        function formatDisplay(d) { return new Date(d).toLocaleDateString('id-ID', {day:'2-digit',month:'2-digit'}); }

        function showLoading(t='Memuat...') { document.getElementById('loadingText').textContent=t; document.getElementById('loading').classList.add('active'); }
        function hideLoading() { document.getElementById('loading').classList.remove('active'); }

        function showToast(msg, type='info') {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = `toast ${type} show`;
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function setConnection(status) {
            const el = document.getElementById('connectionStatus');
            const txt = document.getElementById('connectionText');
            el.className = `connection-status ${status}`;
            txt.textContent = status === 'online' ? 'Online' : status === 'offline' ? 'Offline' : 'Menghubungkan...';
        }

        // ============ API CALLS ============
        async function apiGet(action) {
            try {
                const res = await fetch(`${API_URL}?action=${action}&t=${Date.now()}`);
                const data = await res.json();
                setConnection('online');
                return data;
            } catch(e) {
                console.error(e);
                setConnection('offline');
                return { success: false, error: e.message };
            }
        }

        async function apiPost(payload) {
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                setConnection('online');
                return { success: true };
            } catch(e) {
                console.error(e);
                setConnection('offline');
                return { success: false, error: e.message };
            }
        }

        // ============ NAVIGATION ============
        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + id).classList.add('active');
            if (id === 'absensi') initAbsensi();
            else if (id === 'nilai-bi') initNilai('bi');
            else if (id === 'nilai-ppkn') initNilai('ppkn');
            else if (id === 'kejadian') initKejadian();
        }

        function goToMenu() { 
            showPage('menu'); 
            loadStatistik();
        }

        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // ============ STATISTIK ============
        async function loadStatistik() {
            const res = await apiGet('get-statistik');
            if (res.success && res.data) {
                document.getElementById('stat-siswa').textContent = res.data.totalSiswa || 23;
                document.getElementById('stat-kehadiran').textContent = (res.data.rataKehadiran || 0) + '%';
                document.getElementById('stat-hari').textContent = res.data.hariEfektif || 0;
                document.getElementById('stat-libur').textContent = res.data.hariLibur || 0;
                document.getElementById('stat-kejadian').textContent = res.data.totalKejadian || 0;
            }
        }

        // ============ ABSENSI ============
        async function initAbsensi() {
            document.getElementById('tanggal-absen').value = formatDate(new Date());
            await loadAbsensiByDate();
        }

        async function loadAbsensiByDate() {
            const tanggal = document.getElementById('tanggal-absen').value;
            showLoading('Memuat absensi...');
            
            // Load libur
            const liburRes = await apiGet('get-libur');
            if (liburRes.success) dataLibur = liburRes.data || {};
            
            // Check if holiday
            if (dataLibur[tanggal]) {
                document.getElementById('is-holiday').checked = true;
                document.getElementById('alasan-libur').value = dataLibur[tanggal];
                document.getElementById('alasan-libur').disabled = false;
                document.getElementById('holiday-indicator').style.display = 'block';
                document.getElementById('table-container-absensi').style.display = 'none';
                hideLoading();
                return;
            } else {
                document.getElementById('is-holiday').checked = false;
                document.getElementById('alasan-libur').value = '';
                document.getElementById('alasan-libur').disabled = true;
                document.getElementById('holiday-indicator').style.display = 'none';
                document.getElementById('table-container-absensi').style.display = 'block';
            }
            
            // Load absensi
            const res = await apiGet('get-absensi');
            if (res.success) dataAbsensi = res.data || {};
            
            renderAbsensi(tanggal);
            hideLoading();
        }

        function renderAbsensi(tanggal) {
            const tbody = document.getElementById('tbody-absensi');
            tbody.innerHTML = '';
            const dayData = dataAbsensi[tanggal] || {};
            
            siswaList.forEach((nama, i) => {
                const n = formatNama(nama);
                const status = dayData[nama] || 'H';
                tbody.innerHTML += `
                    <tr>
                        <td class="sticky-col sticky-col-no">${i+1}</td>
                        <td class="sticky-col sticky-col-nama"><div class="nama-siswa"><span class="nama-depan">${n.depan}</span><span class="nama-belakang">${n.belakang}</span></div></td>
                        <td><div class="absen-group">
                            <button class="absen-btn h ${status==='H'?'active':''}" onclick="setAbsen(${i},'H',this)">H</button>
                            <button class="absen-btn s ${status==='S'?'active':''}" onclick="setAbsen(${i},'S',this)">S</button>
                            <button class="absen-btn i ${status==='I'?'active':''}" onclick="setAbsen(${i},'I',this)">I</button>
                            <button class="absen-btn a ${status==='A'?'active':''}" onclick="setAbsen(${i},'A',this)">A</button>
                        </div></td>
                    </tr>`;
            });
        }

        function setAbsen(idx, status, btn) {
            const tanggal = document.getElementById('tanggal-absen').value;
            if (!dataAbsensi[tanggal]) dataAbsensi[tanggal] = {};
            dataAbsensi[tanggal][siswaList[idx]] = status;
            btn.parentElement.querySelectorAll('.absen-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function toggleHoliday() {
            const isHoliday = document.getElementById('is-holiday').checked;
            document.getElementById('alasan-libur').disabled = !isHoliday;
            document.getElementById('holiday-indicator').style.display = isHoliday ? 'block' : 'none';
            document.getElementById('table-container-absensi').style.display = isHoliday ? 'none' : 'block';
        }

        async function saveAbsensi() {
            const tanggal = document.getElementById('tanggal-absen').value;
            const isHoliday = document.getElementById('is-holiday').checked;
            showLoading('Menyimpan...');
            
            if (isHoliday) {
                const alasan = document.getElementById('alasan-libur').value || 'Libur';
                await apiPost({ action: 'save-libur', tanggal, alasan });
            } else {
                const absenData = siswaList.map(nama => ({
                    nama,
                    status: dataAbsensi[tanggal]?.[nama] || 'H'
                }));
                await apiPost({ action: 'save-absensi', tanggal, data: absenData });
            }
            
            hideLoading();
            showToast('Absensi tersimpan!', 'success');
        }

        async function showRekapAbsensi() {
            showLoading('Memuat rekap...');
            const res = await apiGet('rekap-absensi');
            const tbody = document.getElementById('tbody-rekap-absensi');
            tbody.innerHTML = '';
            
            const rekap = res.data || {};
            siswaList.forEach((nama, i) => {
                const d = rekap[nama] || {H:0,S:0,I:0,A:0};
                const total = d.H+d.S+d.I+d.A;
                const persen = total > 0 ? Math.round(d.H/total*100) : 0;
                const n = formatNama(nama);
                tbody.innerHTML += `<tr>
                    <td>${i+1}</td>
                    <td style="text-align:left"><span class="nama-depan">${n.depan}</span><br><span class="nama-belakang">${n.belakang}</span></td>
                    <td class="status-hadir">${d.H}</td>
                    <td class="status-sakit">${d.S}</td>
                    <td class="status-izin">${d.I}</td>
                    <td class="status-alpha">${d.A}</td>
                    <td>${persen}%</td>
                </tr>`;
            });
            
            hideLoading();
            document.getElementById('modal-rekap-absensi').classList.add('active');
        }

        // ============ NILAI ============
        async function initNilai(mapel) {
            showLoading('Memuat nilai...');
            const res = await apiGet(`get-nilai-${mapel}`);
            const data = res.data || {};
            if (mapel === 'bi') dataNilaiBi = data;
            else dataNilaiPpkn = data;
            
            renderNilai(mapel);
            hideLoading();
        }

        function renderNilai(mapel) {
            const tbody = document.getElementById(`tbody-nilai-${mapel}`);
            tbody.innerHTML = '';
            const data = mapel === 'bi' ? dataNilaiBi : dataNilaiPpkn;
            
            siswaList.forEach((nama, i) => {
                const n = formatNama(nama);
                const v = data[nama] || {};
                tbody.innerHTML += `
                    <tr>
                        <td class="sticky-col sticky-col-no">${i+1}</td>
                        <td class="sticky-col sticky-col-nama"><div class="nama-siswa"><span class="nama-depan">${n.depan}</span><span class="nama-belakang">${n.belakang}</span></div></td>
                        <td><input type="number" class="nilai-input" id="${mapel}-nh1-${i}" value="${v.nh1||''}" min="0" max="100" oninput="calcRata('${mapel}',${i})"></td>
                        <td><input type="number" class="nilai-input" id="${mapel}-nh2-${i}" value="${v.nh2||''}" min="0" max="100" oninput="calcRata('${mapel}',${i})"></td>
                        <td><input type="number" class="nilai-input" id="${mapel}-nh3-${i}" value="${v.nh3||''}" min="0" max="100" oninput="calcRata('${mapel}',${i})"></td>
                        <td><input type="number" class="nilai-input" id="${mapel}-nh4-${i}" value="${v.nh4||''}" min="0" max="100" oninput="calcRata('${mapel}',${i})"></td>
                        <td><input type="number" class="nilai-input" id="${mapel}-nh5-${i}" value="${v.nh5||''}" min="0" max="100" oninput="calcRata('${mapel}',${i})"></td>
                        <td><input type="number" class="nilai-input" id="${mapel}-sts-${i}" value="${v.sts||''}" min="0" max="100" oninput="calcRata('${mapel}',${i})"></td>
                        <td><input type="number" class="nilai-input" id="${mapel}-sat-${i}" value="${v.sat||''}" min="0" max="100" oninput="calcRata('${mapel}',${i})"></td>
                        <td><span class="nilai-rata" id="${mapel}-rata-${i}">${v.rata||'-'}</span></td>
                    </tr>`;
            });
        }

        function calcRata(mapel, idx) {
            const fields = ['nh1','nh2','nh3','nh4','nh5','sts','sat'];
            const vals = [];
            const data = mapel === 'bi' ? dataNilaiBi : dataNilaiPpkn;
            const nama = siswaList[idx];
            if (!data[nama]) data[nama] = {};
            
            fields.forEach(f => {
                const inp = document.getElementById(`${mapel}-${f}-${idx}`);
                if (inp) {
                    data[nama][f] = inp.value;
                    if (inp.value) vals.push(parseFloat(inp.value));
                }
            });
            
            const rata = vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1) : '-';
            document.getElementById(`${mapel}-rata-${idx}`).textContent = rata;
        }

        async function saveNilai(mapel) {
            showLoading('Menyimpan nilai...');
            const data = mapel === 'bi' ? dataNilaiBi : dataNilaiPpkn;
            await apiPost({ action: 'save-nilai', mapel, data });
            hideLoading();
            showToast(`Nilai ${mapel==='bi'?'B. Indonesia':'PPKn'} tersimpan!`, 'success');
        }

        async function showRekapNilai(mapel) {
            showLoading('Memuat rekap...');
            const res = await apiGet(`rekap-nilai-${mapel}`);
            const data = res.data || {};
            const container = document.getElementById('content-rekap-nilai');
            
            let html = `<h3 style="margin-bottom:10px;">Nilai ${mapel==='bi'?'B. Indonesia':'PPKn'}</h3>
                <table><thead><tr><th>No</th><th>Nama</th><th>NH1</th><th>NH2</th><th>NH3</th><th>NH4</th><th>NH5</th><th>STS</th><th>SAT</th><th>RataÂ²</th></tr></thead><tbody>`;
            
            siswaList.forEach((nama, i) => {
                const v = data[nama] || {};
                const n = formatNama(nama);
                html += `<tr>
                    <td>${i+1}</td>
                    <td style="text-align:left"><span class="nama-depan">${n.depan}</span><br><span class="nama-belakang">${n.belakang}</span></td>
                    <td>${v.nh1||'-'}</td><td>${v.nh2||'-'}</td><td>${v.nh3||'-'}</td><td>${v.nh4||'-'}</td><td>${v.nh5||'-'}</td>
                    <td>${v.sts||'-'}</td><td>${v.sat||'-'}</td><td><span class="nilai-rata">${v.rata||'-'}</span></td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
            hideLoading();
            document.getElementById('modal-rekap-nilai').classList.add('active');
        }

        // ============ KEJADIAN ============
        async function initKejadian() {
            const select = document.getElementById('select-siswa-kejadian');
            select.innerHTML = '<option value="">-- Pilih --</option>';
            siswaList.forEach(n => select.innerHTML += `<option value="${n}">${n}</option>`);
            document.getElementById('tanggal-kejadian').value = formatDate(new Date());
            
            showLoading('Memuat kejadian...');
            const res = await apiGet('get-kejadian');
            dataKejadian = res.data || [];
            renderKejadian();
            hideLoading();
        }

        function toggleKejadian(el, id) {
            const cb = el.querySelector('input');
            cb.checked = !cb.checked;
            el.classList.toggle('selected', cb.checked);
        }

        function addKejadian() {
            const siswa = document.getElementById('select-siswa-kejadian').value;
            const tanggal = document.getElementById('tanggal-kejadian').value;
            const catatan = document.getElementById('catatan-kejadian').value;
            
            if (!siswa) { showToast('Pilih siswa!', 'error'); return; }
            
            const selected = [];
            document.querySelectorAll('.kejadian-item input:checked').forEach(cb => {
                const id = parseInt(cb.id.replace('kej-',''));
                selected.push(jenisKejadian[id]);
            });
            
            if (!selected.length) { showToast('Pilih pelanggaran!', 'error'); return; }
            
            selected.forEach(k => {
                dataKejadian.push({
                    id: Date.now() + Math.random(),
                    tanggal, siswa,
                    jenis: k.nama,
                    poin: k.poin,
                    catatan
                });
            });
            
            // Reset form
            document.getElementById('select-siswa-kejadian').value = '';
            document.getElementById('catatan-kejadian').value = '';
            document.querySelectorAll('.kejadian-item').forEach(el => {
                el.classList.remove('selected');
                el.querySelector('input').checked = false;
            });
            
            renderKejadian();
            showToast('Kejadian ditambahkan!', 'success');
        }

        function renderKejadian() {
            const tbody = document.getElementById('tbody-kejadian');
            tbody.innerHTML = '';
            
            if (!dataKejadian.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="opacity:0.5">Belum ada data</td></tr>';
                return;
            }
            
            dataKejadian.forEach((k, i) => {
                const totalPoin = dataKejadian.filter(x => x.siswa === k.siswa).reduce((t,x) => t + x.poin, 0);
                const rowClass = totalPoin >= 100 ? 'parent-call' : 'red-mark';
                tbody.innerHTML += `
                    <tr class="${rowClass}">
                        <td>${i+1}</td>
                        <td>${formatDisplay(k.tanggal)}</td>
                        <td>${k.siswa.split(' ')[0]}</td>
                        <td>${k.jenis}</td>
                        <td><span class="poin-badge">${k.poin}</span></td>
                        <td><button class="nav-btn btn-reset" onclick="deleteKejadian(${i})" style="padding:5px 8px;font-size:0.7rem"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
            });
        }

        function deleteKejadian(idx) {
            if (confirm('Hapus kejadian ini?')) {
                dataKejadian.splice(idx, 1);
                renderKejadian();
            }
        }

        async function saveKejadian() {
            showLoading('Menyimpan...');
            await apiPost({ action: 'save-kejadian', data: dataKejadian });
            hideLoading();
            showToast('Kejadian tersimpan!', 'success');
        }

        async function showRekapKejadian() {
            showLoading('Memuat rekap...');
            const res = await apiGet('rekap-kejadian');
            const rekap = res.data || {};
            const tbody = document.getElementById('tbody-rekap-kejadian');
            tbody.innerHTML = '';
            
            siswaList.forEach((nama, i) => {
                const d = rekap[nama] || { totalPoin: 0 };
                let status = 'âœ… Aman';
                let cls = '';
                if (d.totalPoin >= 100) { status = 'ðŸš¨ PANGGIL WALI'; cls = 'parent-call'; }
                else if (d.totalPoin >= 50) { status = 'âš ï¸ Perhatian'; cls = 'red-mark'; }
                
                const n = formatNama(nama);
                tbody.innerHTML += `<tr class="${cls}">
                    <td>${i+1}</td>
                    <td style="text-align:left"><span class="nama-depan">${n.depan}</span><br><span class="nama-belakang">${n.belakang}</span></td>
                    <td><span class="poin-badge">${d.totalPoin}</span></td>
                    <td>${status}</td>
                </tr>`;
            });
            
            hideLoading();
            document.getElementById('modal-rekap-kejadian').classList.add('active');
        }

        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', async () => {
            setConnection('loading');
            await loadStatistik();
        });
    </script>
</body>
</html>